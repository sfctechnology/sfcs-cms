var layout,lockPosition,hideControls,lowDesignerScale,$region,regionHoverInterval,regionHoverIntervalReset=!1;function configureDragAndDrop(){lockPosition||lowDesignerScale?layout.find(".region").draggable("disable").resizable("disable"):layout.find(".region").draggable("enable").resizable("enable")}function updateRegionInfo(e,a){var t=$(this).position(),i=1==$(this).closest(".layout").attr("version")?1/$(this).attr("tip_scale"):$(this).attr("designer_scale");$(".region-tip",this).html(Math.round($(this).width()/i,0)+" x "+Math.round($(this).height()/i,0)+" ("+Math.round(t.left/i,0)+","+Math.round(t.top/i,0)+")")}function regionPositionUpdate(e,a){var t=Preview.instances[$(this).attr("regionid")];t.SetSequence(t.seq),$("#layout-save-all").removeClass("disabled"),$("#layout-revert").removeClass("disabled")}function savePositions(){layout.each((function(){$("#layout-save-all").addClass("disabled"),$("#layout-revert").addClass("disabled");var e=$(this).data().positionAllUrl,a=new Array;$(this).find(".region").each((function(){var e=$(this).attr("designer_scale"),t=$(this).position(),i={width:$(this).width()/e,height:$(this).height()/e,top:t.top/e,left:t.left/e,regionid:$(this).attr("regionid")};$(this).attr("width",i.width).attr("height",i.height),a.push(i)})),$.ajax({type:"put",url:e,cache:!1,dataType:"json",data:{regions:JSON.stringify(a)},success:XiboSubmitResponse})}))}function setFullScreenLayout(e,a){$("#width",".XiboForm").val(e),$("#height",".XiboForm").val(a),$("#top",".XiboForm").val("0"),$("#left",".XiboForm").val("0")}function refreshPreview(e){if(null!=e&&""!==e){var a=Preview.instances[e];void 0!==a?(a.SetSequence(a.seq),$("#layout-status").removeClass("alert-success alert-danger").addClass("alert-info").html("<span class='fa fa-cog fa-spin'></span> "+translations.statusPending)):console.log("No preview to refresh")}else console.log("No preview to refresh")}$(document).ready((function(){var e=$("#layoutJumpList");e.length>0&&(e.select2({ajax:{url:e.data().url,dataType:"json",data:function(e){console.log(e.term);var a={layout:e.term,start:0,length:10};return null!=e.page&&(a.start=10*(e.page-1)),void 0!==e.term&&(localStorage.liveSearchPlaceholder=e.term),a},processResults:function(e,a){var t=[];$.each(e.data,(function(e,a){t.push({id:a.layoutId,text:a.layout})}));var i=a.page||1;return{results:t,pagination:{more:10*(i=i>1?i-1:i)<e.recordsTotal}}},delay:250}}),e.on("select2:select",(function(a){window.location=e.data().designerUrl.replace(":id",a.params.data.id)})).on("select2:opening",(function(a){if(console.log(localStorage.liveSearchPlaceholder),null!=localStorage.liveSearchPlaceholder&&""!==localStorage.liveSearchPlaceholder){var t=e.data("select2").dropdown.$search;t.val(localStorage.liveSearchPlaceholder),setTimeout((function(){t.trigger("input")}),100)}}))),layout=$("#layout"),lockPosition=$("input[name=lockPosition]").length>0&&$("input[name=lockPosition]")[0].checked,hideControls=$("input[name=hideControls]").length>0&&$("input[name=hideControls]")[0].checked,(lowDesignerScale=layout.attr("designer_scale")<.41)&&$("input[name=lockPosition]").attr("disabled",!0),layout.find(".region").hover((function(){$region=$(this),null==regionHoverInterval&&(regionHoverIntervalReset=!1,regionHoverInterval=setTimeout((function(){$region.css("zIndex",900),regionHoverInterval=null,regionHoverIntervalReset=!0}),500)),hideControls||(layout.find(".regionInfo").show(),layout.find(".previewNav").show())}),(function(){regionHoverIntervalReset&&layout.find(".region").each((function(){var e=$(this);e.css("zIndex",e.attr("zindex"))})),layout.find(".regionInfo").hide(),layout.find(".previewNav").hide()})).draggable({containment:layout,stop:regionPositionUpdate,drag:updateRegionInfo}).resizable({containment:layout,minWidth:25,minHeight:25,stop:regionPositionUpdate,resize:updateRegionInfo}),configureDragAndDrop(),$(".regionPreview",layout).each((function(){new Preview(this)})),$("#layout-status").length>0&&(layoutStatus(layout.data("statusUrl")),setInterval("layoutStatus('"+layout.data("statusUrl")+"')",6e4)),$(".switch-check-box").bootstrapSwitch().on("switchChange.bootstrapSwitch",(function(e,a){var t=$(this).prop("name");"lockPosition"==t?(lockPosition=a,configureDragAndDrop()):"hideControls"==t&&((hideControls=a)?($(".region .regionInfo").hide(),$(".region .previewNav").hide()):($(".region .regionInfo").show(),$(".region .previewNav").show())),updateUserPref([{option:t,value:a}])})),setTimeout((function(){$(".region .regionInfo").hide("200"),$(".region .previewNav").hide("200")}),500),$(".RegionOptionsMenuItem").click((function(e){if(e.preventDefault(),$("#layout-save-all").hasClass("disabled")){var a={layoutid:$(this).closest(".region").attr("layoutid"),regionid:$(this).closest(".region").attr("regionid"),scale:$(this).closest(".region").attr("tip_scale"),zoom:$(this).closest(".layout").attr("zoom")};$(this).prop("href"),XiboFormRender($(this),a)}else SystemMessage(translation.savePositionsFirst,!0)})),$("#layout-save-all").on("click",(function(){return savePositions(),!1})),$("#layout-revert").on("click",(function(){return location.reload(),!1})),$("#saveDesignerSize").on("click",(function(){updateUserPref([{option:"defaultDesignerZoom",value:$(this).data().designerSize}])})),$('[data-toggle="tooltip"]').tooltip()}));var loadTimeLineCallback=function(e){e.addClass("modal-big"),e.on("hidden.bs.modal",(function(){refreshPreview($("#layout").data("currentRegionId"))})),$("#layout").data("currentRegionId",$("#timelineControl").attr("regionid")),$("li.timelineMediaListItem").hover((function(){var e=$(this).position();if($("div#timelinePreview").html($("div.timelineMediaPreview",this).html()).css({"margin-top":e.top+$("#timelineControl").closest(".modal-body").scrollTop()}).show(),$hoverPreview=$("#timelinePreview .hoverPreview"),$hoverPreview.css("background",$("#layout").css("background-color")),void 0!==$hoverPreview.data()&&$hoverPreview.data().scale){var a=$("#region_"+$("#timelineControl").attr("regionid")).attr("width"),t=180/a;$("#timelinePreview .hoverPreview").css({width:a,transform:"scale("+t+")","transform-origin":"0 0 "})}}),(function(){return!1})),$(".timelineSortableListOfMedia").sortable(),$(".libraryUploadForm").click(libraryUploadClick)},XiboTimelineSaveOrder=function(e){var a=$("#"+e).data().orderUrl,t=0,i={};$("#"+e+" li.timelineMediaListItem").each((function(){t++,i[$(this).attr("widgetid")]=t})),console.log(i),$.ajax({type:"post",url:a,cache:!1,dataType:"json",data:{widgets:i},success:[XiboSubmitResponse,afterDesignerSave]})};function afterDesignerSave(){$(".regionPreview").each((function(e,a){refreshPreview($(a).attr("regionid"))})),layoutStatus(layout.data("statusUrl"))}var LibraryAssignSubmit=function(){var e=[];$("#LibraryAssignSortable > li").each((function(){e.push($(this).data().mediaId)})),assignMediaToPlaylist($("#LibraryAssign").data().url,e)},assignMediaToPlaylist=function(e,a){toastr.info(a,"Assign Media to Playlist"),$.ajax({type:"post",url:e,cache:!1,dataType:"json",data:{media:a,useDuration:$("#useDuration").is(":checked")},success:XiboSubmitResponse})};function layoutStatus(e){$.ajax({type:"get",url:e,cache:!1,dataType:"json",success:function(e){var a=$("#layout-status");if(e.success){var t=$("<span>").addClass("fa");1==e.extra.status?(a.removeClass("alert-warning alert-info alert-danger").addClass("alert-success"),t.removeClass("fa-question fa-cogs fa-times").addClass("fa-check")):2==e.extra.status?(a.removeClass("alert-success alert-info alert-danger").addClass("alert-warning"),t.removeClass("fa-check fa-cogs fa-times").addClass("fa-question")):3==e.extra.status?(a.removeClass("alert-success alert-warning alert-danger").addClass("alert-info"),t.removeClass("fa-question fa-check fa-times").addClass("fa-cogs")):(a.removeClass("alert-success alert-info alert-warning").addClass("alert-danger"),t.removeClass("fa-question fa-cogs fa-check").addClass("fa-times")),1==e.extra.status?$("#action-tab").find("i").removeClass("fa-bell fa-check fa-times").addClass("fa-check"):2==e.extra.status||3==e.extra.status?$("#action-tab").find("i").removeClass("fa-check fa-times").addClass("fa-bell"):$("#action-tab").find("i").removeClass("fa-bell fa-check fa-times").addClass("fa-times"),1==e.extra.status||2==e.extra.status||3==e.extra.status?$("#schedule-btn").find("i").removeClass("fa-times").addClass("fa-clock-o"):$("#schedule-btn").find("i").removeClass("fa-clock-o").addClass("fa-times");var i=e.html;null!=e.extra.statusMessage&&$.each(e.extra.statusMessage,(function(e,a){i+="<br/>"+a})),a.html(" "+i).prepend(t),$("#layout-duration").html(moment().startOf("day").seconds(e.extra.duration).format("HH:mm:ss"))}else if(e.login)return LoginBox(e.message),!1;return!1}})}function mediaFormCallBack(e){$(e).closest(".modal").addClass("modal-big"),$("#libraryAssignFilterOptions").find("form").on("submit",(function(e){return e.preventDefault(),!1}));var a=$("#mediaAssignments").DataTable({language:dataTablesLanguage,serverSide:!0,stateSave:!0,searchDelay:3e3,order:[[1,"asc"]],filter:!1,ajax:{url:librarySearchUrl,data:function(e){$.extend(e,$("#libraryAssignFilterOptions").find("form").serializeObject())}},columns:[{data:"mediaId"},{data:"name"},{data:"mediaType"},{name:"mediaId",data:null,render:function(e,a,t,i){return"display"===a?""===e.thumbnailUrl?"":'<img src="'+e.thumbnailUrl+'"/>':t.mediaId}},{sortable:!1,data:function(e,a,t,i){return"display"!==a?"":'<a href="#" class="assignItem"><span class="glyphicon glyphicon-plus-sign"></a>'}}]});a.on("draw",(function(e,t){dataTableDraw(e,t),$(".assignItem","#mediaAssignments").click((function(){var e=a.row($(this).closest("tr")).data(),t=$("<li/>",{text:" "+e.name,"data-media-id":e.mediaId,class:"li-sortable",dblclick:function(){$(this).remove()}});t.appendTo("#LibraryAssignSortable"),$("<span/>",{class:"glyphicon glyphicon-minus-sign",click:function(){$(this).parent().remove()}}).prependTo(t)}))})),a.on("processing.dt",dataTableProcessing),$("#LibraryAssignSortable").sortable(),$("#libraryAssignFilterOptions").find("input, select").change((function(){a.ajax.reload()}))}function openUploadForm(e,a){XiboDialogClose();var t=Handlebars.compile($("#template-file-upload").html());bootbox.dialog({message:t(e),title:playlistTrans.uploadMessage,buttons:a,animate:!1,updateInAllChecked:uploadFormUpdateAllDefault,deleteOldRevisionsChecked:uploadFormDeleteOldDefault}),openUploadFormModelShown($(".modal-body").find("form"))}function openUploadFormModelShown(e){var a=libraryAddUrl;e.fileupload({url:a,disableImageResize:!0}),$.support.cors&&$.ajax({url:a,type:"HEAD"}).fail((function(){$('<span class="alert alert-error"/>').text("Upload server currently unavailable - "+new Date).appendTo(e)})),e.fileupload("option","redirect",window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s")),e.bind("fileuploadsubmit",(function(a,t){var i=t.context.find(":input");if(i.filter('[required][value=""]').first().focus().length)return!1;t.formData=i.serializeArray().concat(e.serializeArray()),i.filter("input").prop("disabled",!0)}))}function libraryUploadClick(e){e.preventDefault();var a=$(this).data().validExt.replace(/,/g,"|"),t=$(this).data().playlistId;openUploadForm({trans:playlistTrans,upload:{maxSize:$(this).data().maxSize,maxSizeMessage:$(this).data().maxSizeMessage,validExt:a},playlistId:t},{library:{label:playlistTrans.viewLibrary,callback:function(){XiboFormRender(libraryPlaylistAssignUrl.replace(":id",t))}},main:{label:translations.done,className:"btn-primary",callback:function(){XiboFormRender(timelineForm.url,timelineForm.value)}}})}function mediaEditFormOpen(e){if(1==e.find("form").data().mediaEditable){var a=e.find(".modal-footer"),t=e.find("form").data().mediaId,i=e.find("form").data().widgetId,o=e.find("form").data().validExtensions,s=$('<button class="btn btn-warning">').html(playlistAddFilesTrans.uploadMessage);s.click((function(e){e.preventDefault(),openUploadForm({oldMediaId:t,widgetId:i,updateInAllChecked:uploadFormUpdateAllDefault,trans:playlistAddFilesTrans,upload:{maxSize:$(this).data().maxSize,maxSizeMessage:$(this).data().maxSizeMessage,validExt:o}},{main:{label:translations.done,className:"btn-primary",callback:function(){XiboFormRender(timelineForm.url,timelineForm.value)}}})})),a.find(".btn-primary").before(s)}}