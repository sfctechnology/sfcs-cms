var LOG_LEVEL,VERSION="1.8.3",ID_COUNTER=0;function dsInit(e,i,a){LOG_LEVEL=10,$(".preview-log").css("display","none"),$(".preview-info").css("display","none"),$(".preview-end").css("display","none"),document.onkeypress=keyHandler,playLog(0,"info","Xibo HTML Preview v"+VERSION+" Starting Up",!0),new Layout(e,i,{addedFiles:[],preloader:html5Preloader(),addFiles:function(e){this.addedFiles.includes(e)||(this.preloader.addFiles(e),this.addedFiles.push(e))}},a)}function nextId(){return ID_COUNTER>500&&(ID_COUNTER=0),ID_COUNTER+=1}function playLog(e,i,a,t){if(e<=LOG_LEVEL){var o=timestamp()+" "+i.toUpperCase()+": "+a;e>0&&console.log(o),t&&$(".preview-log").html(o)}}function timestamp(){var e="",i=new Date,a=i.getDate(),t=i.getMonth()+1,o=i.getFullYear(),n=i.getHours(),d=i.getMinutes(),r=i.getSeconds();return d<10&&(d="0"+d),r<10&&(r="0"+r),(e+=a+"/"+t+"/"+o+" ")+(n+":")+d+":"+r}function keyHandler(e){var i="charCode"in e?e.charCode:e.keyCode;if("l"==String.fromCharCode(i)){var a=$(".preview-log");"none"==a.css("display")?a.css("display","block"):a.css("display","none")}}function Layout(e,i,a,t){var o=this;o.id=e,o.parseXlf=function(e){playLog(10,"debug","Parsing Layout "+o.id,!1),o.containerName="L"+o.id+"-"+nextId(),o.regionMaxZIndex=0;var n=$("#screen_"+o.id);n.append('<div id="'+o.containerName+'"></div>'),!1===t&&n.append('<a style="position:absolute;top:0;left:0;width:100%;height:100%;" target="_blank" href="'+n.parent().parent().attr("data-url")+'"></a>');var d=$("#"+o.containerName);if(d.css("display","none"),d.css("outline","red solid thin"),o.sw=n.width(),o.sh=n.height(),playLog(7,"debug","Screen is ("+o.sw+"x"+o.sh+") pixels"),o.layoutNode=e,o.xw=$(o.layoutNode).filter(":first").attr("width"),o.xh=$(o.layoutNode).filter(":first").attr("height"),o.zIndex=$(o.layoutNode).filter(":first").attr("zindex"),playLog(7,"debug","Layout is ("+o.xw+"x"+o.xh+") pixels"),o.scaleFactor=Math.min(o.sw/o.xw,o.sh/o.xh),o.sWidth=Math.round(o.xw*o.scaleFactor),o.sHeight=Math.round(o.xh*o.scaleFactor),o.offsetX=Math.abs(o.sw-o.sWidth)/2,o.offsetY=Math.abs(o.sh-o.sHeight)/2,playLog(7,"debug","Scale Factor is "+o.scaleFactor),playLog(7,"debug","Render will be ("+o.sWidth+"x"+o.sHeight+") pixels"),playLog(7,"debug","Offset will be ("+o.offsetX+","+o.offsetY+") pixels"),d.css("width",o.sWidth+"px"),d.css("height",o.sHeight+"px"),d.css("position","absolute"),d.css("left",o.offsetX+"px"),d.css("top",o.offsetY+"px"),null!=o.zIndex&&d.css("z-index",o.zIndex),o.bgColour=$(o.layoutNode).filter(":first").attr("bgcolor"),o.bgImage=$(o.layoutNode).filter(":first").attr("background"),""!=o.bgImage&&null!=o.bgImage){o.bgId=o.bgImage.substring(0,o.bgImage.indexOf("."));var r=i.layoutBackgroundDownloadUrl.replace(":id",o.id)+"?preview=1";a.addFiles(r+"&width="+o.sWidth+"&height="+o.sHeight+"&dynamic&proportional=0"),d.css("background","url('"+r+"&width="+o.sWidth+"&height="+o.sHeight+"&dynamic&proportional=0')"),d.css("background-repeat","no-repeat"),d.css("background-size",o.sWidth+"px "+o.sHeight+"px"),d.css("background-position","0px 0px")}d.css("background-color",o.bgColour),$(o.layoutNode).find("region").each((function(){playLog(4,"debug","Creating region "+$(this).attr("id"),!1),o.regionObjects.push(new Region(o,$(this).attr("id"),this,i,a))})),playLog(4,"debug","Layout "+o.id+" has "+o.regionObjects.length+" regions"),o.ready=!0,a.addFiles(i.loaderUrl),t?a.preloader.on("finish",o.run):o.run()},o.run=function(){if(playLog(4,"debug","Running Layout ID "+o.id,!1),o.ready){$("#"+o.containerName).css("display","block"),$("#splash_"+o.id).css("display","none");for(var e=0;e<o.regionObjects.length;e++)playLog(4,"debug","Running region "+o.regionObjects[e].id,!1),o.regionObjects[e].run()}else playLog(4,"error","Attempted to run Layout ID "+o.id+" before it was ready.",!1)},o.end=function(){for(var e=0;e<o.regionObjects.length;e++)o.regionObjects[e].end()},o.destroy=function(){},o.regionExpired=function(){playLog(5,"debug","A region expired. Checking if all regions have expired.",!1),o.allExpired=!0;for(var e=0;e<o.regionObjects.length;e++)playLog(4,"debug","Region "+o.regionObjects[e].id+" expired? "+o.regionObjects[e].complete,!1),o.regionObjects[e].complete||(o.allExpired=!1);o.allExpired&&(playLog(4,"debug","All regions have expired",!1),o.end())},o.regionEnded=function(){playLog(5,"debug","A region ended. Checking if all regions have ended.",!1),o.allEnded=!0;for(var e=0;e<o.regionObjects.length;e++)playLog(4,"debug","Region "+o.regionObjects[e].id+": "+o.regionObjects[e].ended,!1),o.regionObjects[e].ended||(o.allEnded=!1);o.allEnded&&(playLog(4,"debug","All regions have ended",!1),o.stopAllMedia(),$("#end_"+o.id).css("display","block"))},o.stopAllMedia=function(){playLog(3,"debug","Stop all media!");for(var e=0;e<o.regionObjects.length;e++)for(var i=o.regionObjects[e],a=0;a<i.mediaObjects.length;a++)i.mediaObjects[a].stop()},o.ready=!1,o.id=e,o.regionObjects=[],o.allExpired=!1,playLog(3,"debug","Loading Layout "+o.id,!0),$.ajax({type:"GET",url:i.getXlfUrl,success:o.parseXlf})}function Region(e,i,a,t,o){var n=this;n.layout=e,n.id=i,n.xml=a,n.mediaObjects=[],n.currentMedia=-1,n.complete=!1,n.containerName="R-"+n.id+"-"+nextId(),n.ending=!1,n.ended=!1,n.oneMedia=!1,n.oldMedia=void 0,n.curMedia=void 0,n.totalMediaObjects=$(n.xml).find("media").length,n.finished=function(){n.complete=!0,n.layout.regionExpired()},n.exitTransition=function(){$("#"+n.containerName).css("display","none"),n.exitTransitionComplete()},n.end=function(){playLog(8,"debug","Region "+n.id+" has ended!"),n.ending=!0,n.exitTransition()},n.exitTransitionComplete=function(){n.ended=!0,n.layout.regionEnded()},n.transitionNodes=function(e,i){var a="1"==i.options.loop||"1"==i.region.options.loop&&1==i.region.totalMediaObjects;e&&e.pause(),(e!=i||a)&&(a&&e==i&&e.reset(),e&&e.stop(),n.ended||(i.run(),$("#"+i.containerName).css("display","block")))},n.nextMedia=function(){n.ended||(n.curMedia?(playLog(8,"debug","nextMedia -> Old: "+n.curMedia.id),n.oldMedia=n.curMedia):n.oldMedia=void 0,n.currentMedia=n.currentMedia+1,n.currentMedia>=n.mediaObjects.length&&(n.finished(),n.currentMedia=0),playLog(8,"debug","nextMedia -> Next up is media "+(n.currentMedia+1)+" of "+n.mediaObjects.length),n.curMedia=n.mediaObjects[n.currentMedia],null!=n.curMedia&&playLog(8,"debug","nextMedia -> New: "+n.curMedia.id),n.transitionNodes(n.oldMedia,n.curMedia))},n.run=function(){n.nextMedia()},n.options=[],$(n.xml).children("options").children().each((function(){playLog(9,"debug","Option "+this.nodeName.toLowerCase()+" -> "+$(this).text(),!1),n.options[this.nodeName.toLowerCase()]=$(this).text()})),n.sWidth=$(a).attr("width")*n.layout.scaleFactor,n.sHeight=$(a).attr("height")*n.layout.scaleFactor,n.offsetX=$(a).attr("left")*n.layout.scaleFactor,n.offsetY=$(a).attr("top")*n.layout.scaleFactor,n.zIndex=$(a).attr("zindex"),$("#"+n.layout.containerName).append('<div id="'+n.containerName+'"></div>'),$("#"+n.containerName).css("width",n.sWidth+"px"),$("#"+n.containerName).css("height",n.sHeight+"px"),$("#"+n.containerName).css("position","absolute"),$("#"+n.containerName).css("left",n.offsetX+"px"),$("#"+n.containerName).css("top",n.offsetY+"px"),null!=n.zIndex&&($("#"+n.containerName).css("z-index",n.zIndex),parseInt(n.zIndex)>n.layout.regionMaxZIndex&&(n.layout.regionMaxZIndex=parseInt(n.zIndex))),playLog(4,"debug","Created region "+n.id,!1),playLog(7,"debug","Render will be ("+n.sWidth+"x"+n.sHeight+") pixels"),playLog(7,"debug","Offset will be ("+n.offsetX+","+n.offsetY+") pixels"),$(n.xml).find("media").each((function(){playLog(5,"debug","Creating media "+$(this).attr("id"),!1),n.mediaObjects.push(new media(n,$(this).attr("id"),this,t,o))})),0==$(n.xml).find("media").length&&($self=$("#"+n.containerName),messageSize=n.sWidth>n.sHeight?n.sHeight:n.sWidth,$self.css("background-color","rgba(255, 0, 0, 0.25)"),$self.append('<div class="empty-message" id="empty_'+n.containerName+'"></div>'),$message=$("#empty_"+n.containerName),$message.append('<span class="empty-icon fa fa-exclamation-triangle" style="font-size:'+messageSize/4+'px"></span>'),$message.append('<span class="empty-icon">'+emptyRegionMessage+"</span>")),playLog(4,"debug","Region "+n.id+" has "+n.mediaObjects.length+" media items")}function media(e,i,a,t,o){var n=this;n.region=e,n.xml=a,n.id=i,n.containerName="M-"+n.id+"-"+nextId(),n.iframeName=n.containerName+"-iframe",n.mediaType=$(n.xml).attr("type"),n.render=$(n.xml).attr("render"),n.attachedAudio=!1,null==n.render&&(n.render="module"),n.run=function(){null!=n.iframe&&$("#"+n.containerName).empty().append(n.iframe),playLog(5,"debug","Running media "+n.id+" for "+n.duration+" seconds"),"video"==n.mediaType&&$("#"+n.containerName+"-vid").get(0).play(),"audio"==n.mediaType&&$("#"+n.containerName+"-aud").get(0).play(),n.attachedAudio&&$("#"+n.containerName+"-attached-aud").get(0).play(),0==n.duration?"video"==n.mediaType?($("#"+n.containerName+"-vid").bind("ended",n.region.nextMedia),$("#"+n.containerName+"-vid").bind("error",n.region.nextMedia),$("#"+n.containerName+"-vid").bind("click",n.region.nextMedia)):"audio"==n.mediaType?($("#"+n.containerName+"-aud").bind("ended",n.region.nextMedia),$("#"+n.containerName+"-aud").bind("error",n.region.nextMedia),$("#"+n.containerName+"-aud").bind("click",n.region.nextMedia)):(n.duration=3,setTimeout(n.region.nextMedia,1e3*n.duration)):setTimeout(n.region.nextMedia,1e3*n.duration)},n.reset=function(){playLog(5,"debug","Reset media "+n.id),"video"==n.mediaType&&($("#"+n.containerName+"-vid").get(0).currentTime=0),"audio"==n.mediaType&&($("#"+n.containerName+"-aud").get(0).currentTime=0),n.attachedAudio&&($("#"+n.containerName+"-attached-aud").get(0).currentTime=0)},n.pause=function(){"video"==n.mediaType&&$("#"+n.containerName+"-vid").get(0).pause(),"audio"==n.mediaType&&$("#"+n.containerName+"-aud").get(0).pause(),n.attachedAudio&&$("#"+n.containerName+"-attached-aud").get(0).pause()},n.stop=function(){playLog(5,"debug","Stop media "+n.id),$("#"+n.containerName).css("display","none")},n.duration=$(n.xml).attr("duration"),n.lkid=$(n.xml).attr("lkid"),n.options=[],$(n.xml).find("options").children().each((function(){playLog(9,"debug","Option "+this.nodeName.toLowerCase()+" -> "+$(this).text(),!1),n.options[this.nodeName.toLowerCase()]=$(this).text()})),"1"===n.options.showfullscreen?(n.divWidth=n.region.layout.sWidth,n.divHeight=n.region.layout.sHeight):(n.divWidth=n.region.sWidth,n.divHeight=n.region.sHeight),$("#"+n.region.containerName).append('<div id="'+n.containerName+'"></div>');var d=$("#"+n.containerName);d.css("display","none"),d.css("width",n.divWidth+"px"),d.css("height",n.divHeight+"px"),d.css("position","absolute"),d.css("background-size","contain"),d.css("background-repeat","no-repeat"),d.css("background-position","center"),"1"===n.options.showfullscreen&&(d.css("left",-n.region.offsetX+"px"),d.css("top",-n.region.offsetY+"px"),d.css("z-index",n.region.layout.regionMaxZIndex+1));var r=t.getResourceUrl.replace(":regionId",n.region.id).replace(":id",n.id)+"?preview=true&raw=true&scale_override="+n.region.layout.scaleFactor,s="1"==n.options.loop||"1"==n.region.options.loop&&1==n.region.totalMediaObjects;if("html"==n.render||"ticker"==n.mediaType){if(n.iframe=$('<iframe scrolling="no" id="'+n.iframeName+'" src="'+r+"&width="+n.divWidth+"&height="+n.divHeight+'" width="'+n.divWidth+'px" height="'+n.divHeight+'px" style="border:0;"></iframe>'),"1"==n.options.durationisperitem||"1"==n.options.durationisperpage){var l=new RegExp("\x3c!-- NUMITEMS=(.*?) --\x3e");jQuery.ajax({url:r+"&width="+n.divWidth+"&height="+n.divHeight,success:function(e){var i=l.exec(e);null!=i&&(n.duration=parseInt(n.duration)*parseInt(i[1]))},async:!1})}}else if("image"==n.mediaType)if(o.addFiles(r),d.css("background-image","url('"+r+"')"),"stretch"==n.options.scaletype)d.css("background-size","cover");else{var c=""==n.options.align?"center":n.options.align,g=""==n.options.valign||"middle"==n.options.valign?"center":n.options.valign;d.css("background-position",c+" "+g)}else if("text"==n.mediaType||"datasetview"==n.mediaType||"webpage"==n.mediaType||"embedded"==n.mediaType)n.iframe=$('<iframe scrolling="no" id="'+n.iframeName+'" src="'+r+"&width="+n.divWidth+"&height="+n.divHeight+'" width="'+n.divWidth+'px" height="'+n.divHeight+'px" style="border:0;"></iframe>');else if("video"==n.mediaType)o.addFiles(r),n.iframe=$('<video id="'+n.containerName+'-vid" preload="auto" '+(1==n.options.mute?"muted":"")+" "+(s?"loop":"")+'><source src="'+r+'">Unsupported Video</video>'),"stretch"==n.options.scaletype&&n.iframe.css("object-fit","fill");else if("audio"==n.mediaType)o.addFiles(r),d.append('<audio id="'+n.containerName+'-aud" preload="auto" '+(s?"loop":"")+" "+(1==n.options.mute?"muted":"")+'><source src="'+r+'">Unsupported Audio</audio>');else if("flash"==n.mediaType){var p='<OBJECT classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" WIDTH="100%" HEIGHT="100%" id="Yourfilename" ALIGN="">';p=p+'<PARAM NAME=movie VALUE="'+r+'"> <PARAM NAME=quality VALUE=high> <param name="wmode" value="transparent"> <EMBED src="'+r+'" quality="high" wmode="transparent" WIDTH="100%" HEIGHT="100%" NAME="Yourfilename" ALIGN="" TYPE="application/x-shockwave-flash" PLUGINSPAGE="http://www.macromedia.com/go/getflashplayer"></EMBED> </OBJECT>',o.addFiles(r),n.iframe=$(p)}else d.css("outline","red solid thin");if($(n.xml).find("audio").length>0){var u=$(n.xml).find("audio"),h=u.find("uri"),m=h.attr("mediaid"),f=t.libraryDownloadUrl.replace(":id",m);if(null!=o.preloader.filesLoadedMap[f]&&o.addFiles(f),null!=h.attr("volume")){var y=h.attr("volume")/100;u.get(0).volume=y}u.prop("loop","1"==h.get(0).getAttribute("loop")),u.attr("id",n.containerName+"-attached-aud"),u.append('<source src="'+f+'">Unsupported Audio'),d.append(u),n.attachedAudio=!0}playLog(5,"debug","Created media "+n.id)}